# WellnessOS — Test + Build Verification Report

Date: 2026-01-14  
Commit tested (initial run): `f8fe986f4f23292862a4bc8b8ca1d1ecca66a183`
Commit tested (post-fix rerun): _(set after commit in this update)_

This report runs the full verification suite and captures command logs under `docs/command-logs/`.

## Summary

- Lint: PASS
- Typecheck: PASS
- Unit/Integration (Vitest): PASS
- Build (Vite + PWA): PASS (dist non-empty)
- E2E (Playwright): PASS (3 tests)
- Security sanity: PASS (E2E validates no plaintext leakage in vault records + export wrapper contains no plaintext secret)
- Knowledge pack sanity: PASS (build + snippet caps verification)

Note: In this sandbox environment, Playwright/preview/tsx required elevated permissions to bind local ports and use OS temp IPC. On a normal machine, these commands run without escalation.

## Commands Run

### Step 0 — Environment + scripts sanity
- `node -v`
- `npm -v`
- `git status --porcelain`
- `git rev-parse HEAD`
- `cat package.json` (scripts only)

Log: `docs/command-logs/00_env.txt`

### Step 1 — Clean install
The prompt requested removing `package-lock.json` and then running `npm ci`. Since `npm ci` requires a lockfile, the lockfile is restored from git before running `npm ci`.

- `rm -rf node_modules`
- `rm -f package-lock.json`
- `git checkout -- package-lock.json`
- `npm ci`

Log: `docs/command-logs/01_clean_install.txt`

### Step 2 — Static checks
- `npm run lint` → `docs/command-logs/02_lint.txt`
- `npm run typecheck` → `docs/command-logs/03_typecheck.txt`

### Step 3 — Unit/integration tests
- `npm test` → `docs/command-logs/04_vitest.txt`
- `npx vitest run --reporter verbose` → `docs/test-results.txt`

### Step 4 — Build
- `npm run build` → `docs/command-logs/05_build.txt`
- dist verification (listing + file count) → `docs/command-logs/05_build_dist.txt`
- optional preview + curl smoke → `docs/command-logs/05_preview_curl.txt` and server log `docs/command-logs/05_preview_server.txt`

### Step 5 — E2E (Playwright)
- `npm run e2e` → `docs/command-logs/06_e2e.txt`

E2E covers:
1) Open app home
2) Open Companion console, send a message, see a response bubble
3) Start a timer via Companion action card, confirm timer state in Tools
4) Open Vault page, verify “Encryption” section renders
5) Ask a hygiene question and confirm citations render

### Step 6 — Security sanity (no plaintext leakage)
Covered by E2E:
- Writes a “secret” chat message
- Reads raw `indexedDB` records from `wellnessos_vault_v1` and asserts the plaintext is not present
- Exports an encrypted backup and asserts the plaintext is not present (and that the wrapper includes ciphertext fields)

See `e2e/smoke.spec.ts` and logs in `docs/command-logs/06_e2e.txt`.

### Step 7 — Knowledge pack sanity
- `npm run knowledge:build` → `docs/command-logs/07_knowledge_build.txt`
- `npx tsx scripts/verify/knowledge-sanity.ts` → `docs/command-logs/08_knowledge_sanity.txt`

The sanity script enforces:
- snippet length ≤ 25 words
- no oversized snippets / keyword lists

Note: The current HTML extraction produced very short snippets (see `docs/command-logs/07_knowledge_build.txt`). This is not a test failure, but it reduces answer usefulness and should be improved in the extraction heuristics if desired.

## Post-fix Rerun (Vault Ledger Digest)

GitHub Actions was failing `src/features/vault/__tests__/vault.test.ts` with:
- `TypeError: Failed to execute 'digest' on 'SubtleCrypto': 2nd argument is not instance of ArrayBuffer, Buffer, TypedArray, or DataView.`

Fix:
- Updated `src/features/vault/crypto.ts` `sha256B64()` to prefer a Node `Buffer` at runtime (when available) to avoid cross-realm `BufferSource` brand-check failures in Node+jsdom test runners, while keeping the browser path unchanged.

Re-verified (post-fix logs):
- Lint + Vitest: `docs/command-logs/10_lint_test_green.txt`
- Knowledge build (network): `docs/command-logs/11_knowledge_build.txt`
- E2E (first attempt fails in sandbox due to port bind restrictions): `docs/command-logs/12_e2e.txt`
- E2E (escalated in sandbox; should not be needed on a normal machine): `docs/command-logs/12_e2e_escalated.txt`
- Knowledge sanity (first attempt fails in sandbox due to tsx IPC pipe restrictions): `docs/command-logs/13_knowledge_sanity.txt`
- Knowledge sanity (escalated in sandbox; should not be needed on a normal machine): `docs/command-logs/13_knowledge_sanity_escalated.txt`

## Fixes Applied During This Run

These were required to make the verification suite and knowledge build succeed:

- Updated trusted sources to avoid dead URLs and keep the knowledge build passing:
  - `data/sources.yml`
  - `services/worker/worker.ts`
  - `public/knowledge/index.json` (regenerated by `npm run knowledge:build`)
- Expanded Playwright E2E to cover required flows and add a vault “no plaintext leakage” assertion:
  - `e2e/smoke.spec.ts`
  - `playwright.config.ts` (runs against `npm run preview` on `127.0.0.1:4173`)
- Added a knowledge pack sanity verifier:
  - `scripts/verify/knowledge-sanity.ts`

## Final Gate (Required)

Re-run the full suite on the final tree:

- `npm run lint`
- `npm run typecheck`
- `npm test`
- `npm run build`
- `npm run e2e`

And confirm: `git status --porcelain` is empty.
